<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Segwik – Schedule Child Meeting (On-Brand Modal)</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#243048; --muted:#667085; --line:#e6ebf2; --accent:#0F2D56; --ok:#0b62ff;
    --chip:#f4f7fb; --chip-line:#e7edf5; --pill:#eaf1ff; --pill-ink:#356aff;
    --person-bg:#f2f4f7; --person-line:#e0e4ec;
    --warn:#B42318; --warn-bg:#FEF3F2; --warn-line:#FEE4E2;
    --ok-bg:#eaf1ff; --ok-line:#cfe0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 1px 0 rgba(16,24,40,.02)}

  /* Header */
  .header{display:flex;align-items:center;gap:12px;padding:8px 8px}
  .header .spacer{flex:1}
  .back{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;color:#0b172a;cursor:pointer}
  .save{background:#eaf1ff;color:#356aff;border:1px solid #cfe0ff;padding:10px 16px;border-radius:10px;font-weight:600;cursor:pointer}
  .save:active{transform:translateY(1px)}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:20}
  .modal.open{display:flex}
  .dialog{
    width:min(980px,98vw);
    max-height:90vh;
    overflow:hidden;
    background:#fff;
    border-radius:14px;
    border:1px solid #e7edf5;
    box-shadow:0 12px 50px rgba(0,0,0,.15);
    display:flex;
    flex-direction:column;
  }
  .panel{padding:16px;flex:1;overflow-y:auto}

  .dialog-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--line)}
  .dialog-head h3{margin:0;font-size:18px}
  .created-pill{margin-left:auto;background:var(--pill);color:var(--pill-ink);border:1px solid #cfe0ff;padding:6px 10px;border-radius:999px;font-size:12px}

  /* Inline select */
  .inline-select{position:relative;display:flex;align-items:baseline;gap:6px;flex-wrap:wrap}
  .inline-label{font-size:14px;line-height:1.2;color:#1f2a44;font-weight:600}
  .inline-value{background:transparent;border:none;padding:0;margin:0;appearance:none;cursor:pointer;font-weight:700;color:var(--ok);font-size:14px;line-height:1.2}
  .inline-value:hover{text-decoration:underline}
  .inline-value:focus-visible{outline:none;text-decoration:underline}
  .inline-menu{position:absolute;z-index:3;top:calc(100% + 6px);left:0;min-width:220px;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.08);display:none;overflow:auto;max-height:240px}
  .inline-menu.open{display:block}
  .inline-option{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f2f5fa}
  .inline-option:last-child{border-bottom:0}
  .inline-option:hover{background:#f8fafc}

  /* Time bar row */
  .timebar{display:flex;align-items:center;justify-content:space-between;gap:16px;background:#f4f7fb;border:1px solid var(--line);border-radius:12px;padding:12px}
  .timebar-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .timebar .input-time{height:46px;border:1px solid #e7edf5;border-radius:8px;padding:0 10px;font-size:15px}
  .timebar-sep{margin:0 6px;color:var(--muted);font-weight:700}
  .timebar-right{display:flex;align-items:center;gap:8px}
  .timebar-right .inline-label{font-weight:700}

  .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:8px}
  label{font-size:14px;color:#1f2a44;font-weight:600}
  .hint{font-size:12px;color:#667085}
  .input, select, input[type="datetime-local"]{width:100%;height:46px;border:1px solid #e7edf5;border-radius:8px;padding:0 12px;font-size:15px;color:#0f1f3a;background:#fff;outline:none}
  .input::placeholder{color:#97a3b6}
  select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23667085" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:right 12px center;background-size:18px}

  /* Status chips */
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--chip-line);border-radius:999px;padding:8px 10px;font-size:12px;cursor:pointer}
  .chip[data-active="true"]{background:#eaf1ff;border-color:#cfe0ff;color:#356aff}

  /* People tabs */
  .subtabs{display:inline-flex;align-items:center;gap:2px;padding:4px;border:1px solid var(--line);border-radius:12px;background:#eef4fb;margin-top:6px}
  .subtab{background:transparent;border:none;border-radius:10px;padding:8px 14px;font-weight:600;color:#1f2a44;cursor:pointer}
  .subtab[aria-selected="true"]{background:#fff;box-shadow:0 1px 2px rgba(16,24,40,.06);border:1px solid var(--line)}

  .subpanel{padding:12px;display:none}
  .subpanel.active{display:block}
  .list{display:flex;flex-direction:column;gap:8px}

  /* Person card */
  .person-card{display:flex;align-items:center;justify-content:space-between;gap:12px;background:var(--person-bg);border:1px solid var(--person-line);border-radius:12px;padding:12px;cursor:default}
  .person-card[data-clickable="true"]{cursor:pointer}
  .person-left{display:flex;align-items:center;gap:12px;min-width:0;flex:1}
  .avatar{width:36px;height:36px;border-radius:50%;flex:0 0 36px;background:#e6ecf7;color:#0f2142;display:grid;place-items:center;font-weight:700;font-size:14px;overflow:hidden;border:1px solid #dfe6f3}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .meta{min-width:0}
  .name-row{display:flex;align-items:center;gap:8px}
  .name-row strong{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
  .remove-x{background:transparent;border:none;color:#1f2a44;opacity:.7;cursor:pointer;font-size:16px;line-height:1}
  .remove-x:hover{opacity:1}
  .subline{font-size:12px;color:#667085;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .person-right{display:flex;align-items:center;gap:10px}

  .view-link{display:inline;color:#0b62ff;font-weight:600;text-decoration:underline;border:none;background:transparent;padding:0;border-radius:0}
  .view-link:hover{opacity:.9}

  /* Suggested contacts */
  .suggested-box{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto}
  .suggested-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px;border:1px solid #eef2f7;border-radius:8px;background:#fafcff}
  .suggested-row .meta{min-width:0}
  .suggested-row .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .suggested-row .email{font-size:12px;color:#var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Availability */
  .avail{border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px}
  .avail-head{display:flex;align-items:center;justify-content:space-between}
  .avail.reference{background:#f7f8fb;border-style:dashed;position:relative}
  .ref-banner{display:flex;align-items:center;gap:8px;background:#eef1f6;border:1px solid #dfe4ee;color:#475467;padding:8px 10px;border-radius:8px;font-size:12px;font-weight:700;margin:8px 0 12px 0}
  .ref-banner svg{flex:0 0 auto}
  .cal, .time-panel{background:#fff;box-shadow:0 1px 0 rgba(16,24,40,.02)}
  .avail-head strong{color:#101828}
  .avail-muted{color:#667085}
  .avail-warn{color:var(--warn);font-weight:700}

  .time-panel{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;min-height:260px}
  .time-panel h4{margin:0 0 8px 0}
  .time-list{display:flex;flex-direction:column;gap:10px}
  .time-row{border:none;background:transparent;padding:6px 8px;font-weight:600;color:#0b62ff;border-radius:8px; text-align:left; width:100%} /* LEFT align time buttons */
  .time-row.active{outline:2px solid var(--ok);background:var(--ok-bg)}
  .time-empty{color:#667085;font-size:14px;padding:12px}

  /* Mini badge */
  .role-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;line-height:1;border:1px solid var(--ok-line);background:var(--ok-bg);color:#356aff}
  .conflict-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700;line-height:1;border:1px solid var(--warn-line);background:var(--warn-bg);color:var(--warn)}

  /* Footer actions */
  .actions{display:flex;justify-content:flex-end;gap:10px;padding:12px;border-top:1px solid var(--line);flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d0d7e2;background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.ghost{background:#f4f7fb}
  .error-note{flex-basis:100%;color:#B42318;background:#FEF3F2;border:1px solid #FEE4E2;padding:8px 10px;border-radius:8px;font-size:12px;display:none}

  @media (max-width:940px){.grid3{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}.avail-days{grid-template-columns:repeat(2,1fr)}}
  .list-item .row{flex-wrap:nowrap;gap:8px}
  .list-item .btn{padding:8px 10px}

  /* Calendar */
  .cal-wrap{display:grid;grid-template-columns: 320px 1fr; gap:20px; align-items:start}
  @media (max-width:860px){ .cal-wrap{grid-template-columns:1fr} }
  .cal{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
  .cal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .cal-nav{display:flex;align-items:center;gap:8px}
  .cal-nav .chip{padding:6px 10px}
  .cal-month{font-weight:700}
  .cal-grid{display:grid;grid-template-columns: repeat(7, 1fr);gap:6px;padding:12px}
  .cal-dow{font-size:11px;color:#667085;text-transform:uppercase;text-align:center}
  /* LEFT-ALIGNED DATE NUMBERS */
  .cal-day{
    height:40px;display:flex;align-items:flex-start;justify-content:flex-start;
    border-radius:10px;cursor:pointer;border:1px solid transparent;color:var(--ink);
    background:#fff;padding-left:8px;padding-top:6px
  }
  .cal-day:hover{border-color:#dfe6f3;background:#f7faff}
  .cal-day.out{color:#a7b1c2;background:#fafbfe}
  .cal-day.today{outline:2px solid #e0ebff}
  .cal-day.selected{background:#eaf1ff;border-color:#cfe0ff;color:#0b62ff;font-weight:700}

  /* Step 3 Rich text editors */
  .rte{border:1px solid #e7edf5;border-radius:10px;min-height:120px;padding:10px;background:#fff}
  .rte[contenteditable="true"]:focus{outline:2px solid #cfe0ff}

  /* Step 4 Agenda */
  .agenda-list{display:flex;flex-direction:column;gap:10px}
  .agenda-item{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px}
  .agenda-handle{width:30px;height:30px;border-radius:6px;border:1px solid #e7edf5;display:grid;place-items:center;cursor:grab;user-select:none;background:#f6f8fb}
  .dots{display:grid;grid-template-columns:repeat(2,4px);grid-auto-rows:4px;gap:4px}
  .dots span{width:4px;height:4px;background:#97a3b6;border-radius:1px;display:block}
  .agenda-main{flex:1;min-width:0}
  .agenda-title{font-weight:700}
  .agenda-sub{font-size:12px;color:#667085}
  .agenda-actions{display:flex;gap:8px}
  .icon-btn{border:1px solid #d0d7e2;background:#fff;border-radius:8px;padding:8px;cursor:pointer}
  .icon{width:16px;height:16px;display:inline-block}
  .agenda-editing .view{display:none}
  .agenda-editing .edit{display:block}
  .edit{display:none}
  .edit-row{display:flex;gap:8px;margin-top:6px}
  .edit-row input{height:40px}
  .add-agenda{margin-top:8px}
  .inline-num{width:120px}

  /* Step 5 Location */
  .loc-tabs{display:inline-flex;gap:8px;background:#eef4fb;border:1px solid var(--line);border-radius:12px;padding:4px}
  .loc-tab{padding:8px 14px;border:none;border-radius:10px;background:transparent;font-weight:600;cursor:pointer}
  .loc-tab[aria-selected="true"]{background:#fff;border:1px solid var(--line)}
  .loc-panel{margin-top:12px}
  .recommended{margin-top:8px}
  .rec-list{display:flex;flex-direction:column;gap:8px}
  .rec-item{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
  .rec-item .btn{padding:6px 10px}
  .search-org{height:46px;border:1px solid #e7edf5;border-radius:8px;padding:0 12px;width:100%}
  .zoom-input{height:46px;border:1px solid #e7edf5;border-radius:8px;padding:0 12px;width:100%}
  .muted{color:#667085;font-size:13px}
  .hidden{display:none !important}

  /* Selected location (plain text) */
  .selected-loc{margin:8px 0 4px;font-size:14px;color:#0b62ff;font-weight:400}

  /* Add New Location overlay */
  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:30;padding:16px}
  .overlay.open{display:flex}
  .loc-modal{width:min(560px,96vw);background:#fff;border:1px solid #e7edf5;border-radius:12px;box-shadow:0 14px 60px rgba(0,0,0,.2)}
  .loc-modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .loc-modal-head h4{margin:0;font-size:16px}
  .loc-modal-body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .loc-modal-body .full{grid-column:1 / -1}
  .loc-modal-close{background:transparent;border:none;font-size:18px;cursor:pointer}
  .loc-modal-foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}

  /* Fixed "Meeting Stage: Scheduling" header pill */
  .stage-tag{margin-left:auto;display:flex;align-items:center;gap:8px}
  .stage-label{font-size:12px;font-weight:700;color:#1f2a4}
  .stage-pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cfe0ff;color:#356aff;background:#eaf1ff;font-size:12px;font-weight:700;line-height:1;white-space:nowrap}

  /* Hide Meeting Stage & Status fields across steps */
  .field:has(#stageSelect), .field:has(#stageValue_s3), .field:has(#stageValue_s4), .field:has(#stageValue_s5),
  .field:has(#statusSelect), .field:has(#statusValue_s3), .field:has(#statusValue_s4), .field:has(#statusValue_s5){display:none!important}
  .grid3:has(#statusSelect), .grid3:has(#statusValue_s3), .grid3:has(#statusValue_s4), .grid3:has(#statusValue_s5){grid-template-columns:1fr!important}
  .grid3:has(#stageSelect), .grid3:has(#stageValue_s3), .grid3:has(#stageValue_s4), .grid3:has(#stageValue_s5){grid-template-columns:2fr 1fr!important}
  .field:has(#meetingName), .field:has(#meetingName_s3), .field:has(#meetingName_s4), .field:has(#meetingName_s5){grid-column:1 / -1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="back" title="Back" aria-label="Back">&#8592;</div>
      <div class="spacer"></div>
      <button class="save" id="openModal">+ Schedule Meeting</button>
    </div>

    <!-- On-brand modal -->
    <div class="modal" id="modal">
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
        <div class="dialog-head">
          <h3 id="dlgTitle">Step 2</h3>
          <div class="stage-tag" id="fixedStageHeader" aria-label="Meeting Stage">
            <span class="stage-label">Meeting Stage:</span>
            <span class="stage-pill">Scheduling</span>
          </div>
        </div>

        <div class="panel">
          <!-- =============== STEP 2 PANEL =============== -->
          <div id="step2Panel">
            <!-- Row 1: Meeting name -->
            <div class="grid3">
              <div class="field">
                <label for="meetingName">Meeting name</label>
                <input class="input" id="meetingName" />
              </div>

              <div class="field">
                <div class="inline-select" id="statusSelect">
                  <span class="inline-label">Meeting Status:</span>
                  <button type="button" class="inline-value" id="statusValue">Active</button>
                  <div class="inline-menu" id="statusMenu"></div>
                </div>
              </div>

              <div class="field">
                <div class="inline-select" id="stageSelect">
                  <span class="inline-label">Meeting Stage:</span>
                  <button type="button" class="inline-value" id="stageValue">Scheduled</button>
                  <div class="inline-menu" id="stageMenu"></div>
                </div>
              </div>
            </div>

            <!-- Row 2: Start/End + Timezone -->
            <div class="timebar" style="margin-top:12px">
              <div class="timebar-left">
                <input type="date" class="input-time" id="startDate">
                <input type="time" class="input-time" id="startTime" step="900">
                <span class="timebar-sep">to</span>
                <input type="date" class="input-time" id="endDate">
                <input type="time" class="input-time" id="endTime" step="900">
              </div>
              <div class="timebar-right">
                <span class="inline-label">Timezone:</span>
                <div class="inline-select" id="tzSelect">
                  <button type="button" class="inline-value" id="tzValue">America/New_York</button>
                  <div class="inline-menu" id="tzMenu"></div>
                </div>
              </div>
            </div>

            <!-- Row 3: Subtabs Staff | Invitees -->
            <div class="subtabs" role="tablist" aria-label="Participant setup" style="margin-top:16px">
              <button class="subtab" id="tabStaff" aria-selected="true" aria-controls="panelStaff">Staff</button>
              <button class="subtab" id="tabInvitees" aria-selected="false" aria-controls="panelInvitees">Invitees</button>
            </div>

            <!-- Staff Panel -->
            <div id="panelStaff" class="subpanel active" role="tabpanel" aria-labelledby="tabStaff">
              <div class="field">
                <label for="attendingStaff">Staff</label>
                <div class="row">
                  <select id="attendingStaff" style="flex:1"></select>
                </div>
              </div>
              <!-- Removed the chosen-staff list under the search box -->
            </div>

            <!-- Invitees Panel -->
            <div id="panelInvitees" class="subpanel" role="tabpanel" aria-labelledby="tabInvitees">
              <div class="grid2">
                <div class="field">
                  <label for="customerPicker">Contacts</label>
                  <div class="row">
                    <select id="customerPicker" style="flex:1"></select>
                  </div>
                  <div class="hint">
                    <a href="#" id="addContactLink" style="color:#356aff;text-decoration:underline">+Add Contact</a>
                  </div>
                </div>

                <div class="field">
                  <label>Suggested contacts</label>
                  <div class="suggested-box" id="suggestedContacts"></div>
                </div>
              </div>

              <!-- Removed "Invitee list" block -->
            </div>

            <!-- Grouped list (always visible): Staff then Invitees -->
            <div style="margin-top:16px" id="groupedBlock">
              <label>Staff</label>
              <div class="list" id="groupStaff"></div>

              <div style="height:8px"></div>
              <label>Invitees</label>
              <div class="list" id="groupInvitees"></div>
            </div>

            <!-- Availability (always visible) -->
            <div id="availabilityMount"></div>
          </div>

          <!-- =============== STEP 3 PANEL =============== -->
          <div id="step3Panel" class="hidden">
            <div class="grid3">
              <div class="field">
                <label for="meetingName_s3">Meeting name</label>
                <input class="input" id="meetingName_s3" />
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Status:</span>
                  <button type="button" class="inline-value" id="statusValue_s3">Active</button>
                  <div class="inline-menu" id="statusMenu_s3"></div>
                </div>
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Stage:</span>
                  <button type="button" class="inline-value" id="stageValue_s3">Scheduled</button>
                  <div class="inline-menu" id="stageMenu_s3"></div>
                </div>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div class="field" style="grid-column:1 / -1">
                <label for="shortDesc">Short Description</label>
                <textarea id="shortDesc" class="input" placeholder=""></textarea>
              </div>
              <div class="field" style="grid-column:1 / -1">
                <label>Long Description</label>
                <div id="longDesc" class="rte" contenteditable="true" spellcheck="true"></div>
              </div>
              <div class="field" style="grid-column:1 / -1">
                <label>Notes</label>
                <div id="notesDesc" class="rte" contenteditable="true" spellcheck="true"></div>
              </div>
            </div>
          </div>

          <!-- =============== STEP 4 PANEL =============== -->
          <div id="step4Panel" class="hidden">
            <div class="grid3">
              <div class="field">
                <label for="meetingName_s4">Meeting name</label>
                <input class="input" id="meetingName_s4" />
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Status:</span>
                  <button type="button" class="inline-value" id="statusValue_s4">Active</button>
                  <div class="inline-menu" id="statusMenu_s4"></div>
                </div>
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Stage:</span>
                  <button type="button" class="inline-value" id="stageValue_s4">Scheduled</button>
                  <div class="inline-menu" id="stageMenu_s4"></div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="agenda-list" id="agendaList"></div>
              <button class="btn add-agenda" id="addAgendaBtn">+ Add Agenda Item</button>
            </div>
          </div>

          <!-- =============== STEP 5 PANEL =============== -->
          <div id="step5Panel" class="hidden">
            <div class="grid3">
              <div class="field">
                <label for="meetingName_s5">Meeting name</label>
                <input class="input" id="meetingName_s5" />
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Status:</span>
                  <button type="button" class="inline-value" id="statusValue_s5">Active</button>
                  <div class="inline-menu" id="statusMenu_s5"></div>
                </div>
              </div>
              <div class="field">
                <div class="inline-select">
                  <span class="inline-label">Meeting Stage:</span>
                  <button type="button" class="inline-value" id="stageValue_s5">Scheduled</button>
                  <div class="inline-menu" id="stageMenu_s5"></div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Location</label>
              <div id="selectedLocation" class="selected-loc hidden"></div>

              <div class="loc-tabs" role="tablist" aria-label="Location mode">
                <button class="loc-tab" id="locInPerson" aria-selected="true">In-Person</button>
                <button class="loc-tab" id="locVirtual" aria-selected="false">Virtual</button>
              </div>

              <div id="inPersonPanel" class="loc-panel">
                <div class="recommended">
                  <div class="muted" style="margin-bottom:6px">Recommended Locations</div>
                  <div class="rec-list" id="recList" style="margin-top:8px"></div>

                  <div style="margin-top:10px" class="field">
                    <input class="search-org" id="orgSearch" placeholder="Search organization to get Location">
                    <div id="searchResults" class="rec-list" style="margin-top:8px"></div>
                    <div style="margin-top:8px">
                      <button id="addNewLink" style="background:none;border:none;color:#0b62ff;cursor:pointer;font-weight:700;padding:0">+ Add New</button>
                    </div>
                  </div>
                </div>
              </div>

              <div id="virtualPanel" class="loc-panel hidden">
                <div class="field">
                  <label for="zoomUrl">Zoom Url</label>
                  <input id="zoomUrl" class="zoom-input" placeholder="Zoom Url">
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /panel -->

        <!-- Footer actions -->
        <div class="actions">
          <button class="btn ghost" id="closeModal">Cancel</button>
          <button class="btn" id="backBtn" class="hidden">Back</button>
          <button class="btn" id="saveDraftBtn">Save as Draft</button>
          <button class="btn primary" id="nextBtn">Next</button>
          <button class="btn primary hidden" id="scheduleBtn">Schedule Meeting</button>

          <div id="step2Error" class="error-note">Please add at least one Invitee and one Staff member before proceeding.</div>
        </div>
      </div> <!-- /dialog -->
    </div> <!-- /modal -->
  </div> <!-- /wrap -->

  <!-- ===== Add New Location Overlay ===== -->
  <div class="overlay" id="addLocOverlay" aria-hidden="true">
    <div class="loc-modal" role="dialog" aria-modal="true" aria-labelledby="addLocTitle">
      <div class="loc-modal-head">
        <h4 id="addLocTitle">Add New Location</h4>
        <button class="loc-modal-close" id="addLocClose" aria-label="Close">✖</button>
      </div>
      <div class="loc-modal-body">
        <div class="field full">
          <label for="addr1">Address</label>
          <input class="input" id="addr1" placeholder="123 Main St" />
        </div>
        <div class="field full">
          <label for="addr2">Address 2</label>
          <input class="input" id="addr2" placeholder="Suite / Apt" />
        </div>
        <div class="field">
          <label for="city">City</label>
          <input class="input" id="city" placeholder="City" />
        </div>
        <div class="field">
          <label for="state">State</label>
          <input class="input" id="state" placeholder="State" />
        </div>
        <div class="field full">
          <label for="zip">Zip</label>
          <input class="input" id="zip" placeholder="Zip" />
        </div>
      </div>
      <div class="loc-modal-foot">
        <button class="btn" id="addLocCancel">Cancel</button>
        <button class="btn primary" id="saveLocationBtn">Save Location</button>
      </div>
    </div>
  </div>

<script>
  // ===== Dummy Data =====
  const STATUS_OPTIONS = ['Draft','Active'];
  const TZ_OPTIONS     = ['America/New_York','America/Chicago','America/Denver','America/Los_Angeles','UTC'];

  function mountInlineMenu(buttonEl, menuEl, options, onChoose){
    menuEl.innerHTML = options.map(opt=>`<div class="inline-option" data-val="${opt}">${opt}</div>`).join('');
    buttonEl.addEventListener('click', (e)=>{ e.stopPropagation(); menuEl.classList.toggle('open'); });
    menuEl.addEventListener('click', (e)=>{
      const val = e.target?.getAttribute?.('data-val');
      if(!val) return;
      onChoose(val);
      menuEl.classList.remove('open');
    });
    document.addEventListener('click', ()=> menuEl.classList.remove('open'));
  }

  // Organizer (scheduler)
  const organizer = {
    id:'u-org',
    name:'Pete Romano',
    title:'Organizer',
    tz:'America/New_York',
    email:'pete@segwik.com',
    phone:'',
    profileUrl:'#',
    avatar:''
  };

  const loggedInUser = { id: 'u-100', name: 'Alex Johnson', email: 'alex@segwik.example' };

  // Internal users
  const internalUsers = [
    organizer,
    { id:'u-101', name:'Priya Patel',   title:'Account Executive',     tz:'America/New_York', email:'priya@segwik.example',  phone:'(201) 555-0191', profileUrl:'#', avatar:'' },
    { id:'u-102', name:'Miguel Santos', title:'Solutions Consultant',  tz:'America/New_York', email:'miguel@segwik.example', phone:'(212) 555-0127', profileUrl:'#', avatar:'' },
    { id:'u-103', name:'Jade Williams', title:'CSM',                   tz:'America/New_York', email:'jade@segwik.example',   phone:'(973) 555-0114', profileUrl:'#', avatar:'' },
  ];

  const customers = [
    { id:'c-201', name:'Acme Corp – Dana Scott', email:'dana@acme.example', phone:'(973) 555-0100', profileUrl:'#', avatar:'' },
    { id:'c-202', name:'Rivertown Realty – Chris Lee', email:'chris@rivertown.example', phone:'(551) 555-0142', profileUrl:'#', avatar:'' },
    { id:'c-203', name:'Blue Harbor Dental – Dr. N. Patel', email:'np@bh-dental.example', phone:'(201) 555-0176', profileUrl:'#', avatar:'' },
    { id:'c-204', name:'Fresh Start Advancement – Anthony Rosa', email:'anthony@fsa.example', phone:'(914) 555-0153', profileUrl:'#', avatar:'' },
  ];
  let suggested = [
    { id:'c-205', name:'Garden State Roofing – Alicia Kim', email:'alicia@gstate.example', phone:'', profileUrl:'#', avatar:'' },
    { id:'c-206', name:'Oceanview Fitness – Mark Chen', email:'mark@ovfit.example', phone:'', profileUrl:'#', avatar:'' },
    { id:'c-207', name:'North Ridge Pediatrics – Dr. Lee', email:'lee@nrpeds.example', phone:'', profileUrl:'#', avatar:'' },
  ];

  const ORG_LOCATIONS = [
    'Segwik HQ, 10 River Dr S, Jersey City, NJ',
    'City Lifestyle Media, 77 Hudson St, Jersey City, NJ',
    'Harborside Atrium, 200 Hudson St, Jersey City, NJ',
    'Liberty Science Center, 222 Jersey City Blvd, Jersey City, NJ',
    'Journal Square PATH, 1 Journal Square, Jersey City, NJ'
  ];

  // ===== State =====
  const state = {
    step: 2,
    status:'Active',
    stage:'Scheduling',
    timezone:'America/New_York',
    staff: organizer.id,               // start on organizer
    weekOffset:0,
    invitees:[],
    staffOnMeeting:[{ id: organizer.id }], // organizer auto-added
    meetingName:'',
    descriptions:{ short:'', long:'', notes:'' },
    agendas: [
      { id: 'a1', title:'Welcome & Context', duration:2, desc:'Quick intros, meeting flow, confirm time constraints.' },
      { id: 'a2', title:'Goals & Success Criteria', duration:5, desc:'Clarify primary objectives for the next 90 days and how success will be measured.' },
      { id: 'a3', title:'Audience & Current Marketing', duration:7, desc:'Who they need to reach; what’s running today; what’s working/not; budget comfort.' },
      { id: 'a4', title:'Editorial & Benefits Overview', duration:6, desc:'How City Lifestyle blends editorial features, print + digital placements, and event amplification (City Scene, calendars); discuss story angles and asset readiness.' },
      { id: 'a5', title:'Packages, Timing & Fit', duration:6, desc:'Align on timing (launch windows), expected outcomes, and budget band; confirm decision process.' },
      { id: 'a6', title:'Next Steps & Scheduling', duration:3, desc:'Decide path (proposal / editorial kickoff / follow-up), assign action items, and schedule any follow-up.' },
      { id: 'a7', title:'Close', duration:1, desc:'Recap commitments and thank them for their time.' }
    ],
    locationMode: 'inperson',
    recommended: [
      '123 Main Street, Jersey City, NJ',
      '77 Hudson St, Jersey City, NJ',
      '1 Journal Square, Jersey City, NJ'
    ],
    zoomUrl: '',
    selectedLocation: '',
    refMonth: new Date(new Date().getFullYear(), 10, 1),  // default to November
    selectedCalDate: new Date()
  };
  const defaultSlotMinutes = 30;

  // ===== Utilities =====
  function pad(n){return String(n).padStart(2,'0')}
  function toISO(d){const y=d.getFullYear(),m=pad(d.getMonth()+1),dy=pad(d.getDate()),hh=pad(d.getHours()),mm=pad(d.getMinutes());return `${y}-${m}-${dy}T${hh}:${mm}`}
  function off(days,h=9,m=0){const d=new Date();d.setDate(d.getDate()+days);d.setHours(h,m,0,0);return d.toISOString()}
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function formatMonthLabel(d){ return d.toLocaleDateString(undefined, { month:'long', year:'numeric' }); }
  function dayNameShort(idx){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][idx]; }
  function fmtTime(d){return d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})}
  function displayNameNameFirst(label){
    const parts = label.split(/—|–/).map(s=>s.trim());
    if(parts.length === 2){ const [company, person] = parts; return `${person} — ${company}`; }
    return label;
  }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function dateAtTime(baseDate, hhmm){ const [hh,mm] = hhmm.split(':').map(Number); const d = new Date(baseDate); d.setHours(hh, mm, 0, 0); return d; }

  // Robust initials: take the person-side of the string (before any dash) and use first two words
  function initialsFromName(raw){
    const normalized = displayNameNameFirst(raw || '');
    const personPart = normalized.split(/[—–-]/)[0].trim();
    const parts = personPart.split(/\s+/).filter(Boolean);
    const a = (parts[0]?.[0]||'').toUpperCase();
    const b = (parts[1]?.[0]||'').toUpperCase();
    return (a + b) || '•';
  }

  function getProposedRange(){
    const sd = startDate.value, st = startTime.value, ed = endDate.value, et = endTime.value;
    if(!sd || !st || !ed || !et) return null;
    const s = new Date(`${sd}T${st}`);
    const e = new Date(`${ed}T${et}`);
    return { start: s, end: e };
  }
  function rangesOverlap(a,b){ return a.start < b.end && b.start < a.end; }

  function renderSuggested(){
    const suggestedContacts = document.getElementById('suggestedContacts');
    suggestedContacts.innerHTML = suggested.map(c=>`
      <div class="suggested-row">
        <div class="meta" style="flex:1;min-width:0">
          <div class="name">${displayNameNameFirst(c.name)}</div>
          <div class="email">${c.email}</div>
        </div>
        <button class="btn" data-add-contact="${c.id}">Add</button>
      </div>
    `).join('');
  }

  // ===== Availability model (November weekdays; no weekends) =====
  const NOV_TEMPLATES = {
    'u-org': { // Organizer Pete
      1:[["09:00","09:30"],["11:00","11:30"],["14:00","14:30"]],
      2:[["10:00","10:30"],["13:00","13:30"],["16:00","16:30"]],
      3:[["09:30","10:00"],["12:30","13:00"],["15:30","16:00"]],
      4:[["11:15","11:45"],["14:15","14:45"]],
      5:[["09:00","09:30"],["10:45","11:15"],["13:30","14:00"]]
    },
    'u-101': { // Priya
      1:[["10:00","10:30"],["13:00","13:30"],["16:00","16:30"]],
      2:[["09:00","09:30"],["11:30","12:00"],["15:00","15:30"]],
      3:[["08:30","09:00"],["12:00","12:30"],["14:30","15:00"]],
      4:[["09:15","09:45"],["11:45","12:15"],["14:15","14:45"]],
      5:[["10:30","11:00"],["13:30","14:00"]]
    },
    'u-102': { // Miguel
      1:[["08:30","09:00"],["12:00","12:30"],["15:00","15:30"]],
      2:[["09:30","10:00"],["13:30","14:00"],["16:30","17:00"]],
      3:[["10:00","10:30"],["11:30","12:00"],["14:30","15:00"]],
      4:[["08:00","08:30"],["10:00","10:30"],["13:00","13:30"]],
      5:[["09:00","09:30"],["11:00","11:30"],["14:00","14:30"]]
    },
    'u-103': { // Jade
      1:[["09:15","09:45"],["11:45","12:15"],["14:15","14:45"]],
      2:[["10:15","10:45"],["12:45","13:15"]],
      3:[["09:45","10:15"],["13:15","13:45"],["16:00","16:30"]],
      4:[["10:30","11:00"],["14:30","15:00"]],
      5:[["09:00","09:30"],["12:00","12:30"],["15:00","15:30"]]
    }
  };

  function isNovember(d){ return d.getMonth()===10; } // 0=Jan, 10=Nov
  function getSlotsForUserOnDate(userId, date){
    const dow = date.getDay(); if(dow===0 || dow===6) return [];
    if(isNovember(date) && NOV_TEMPLATES[userId]?.[dow]){
      return NOV_TEMPLATES[userId][dow].map(([s,e])=>({ start: dateAtTime(date,s), end: dateAtTime(date,e) }));
    }
    const fallbacks = {
      'u-org' : [["09:00","09:30"],["14:00","14:30"]],
      'u-101' : [["10:00","10:30"],["15:00","15:30"]],
      'u-102' : [["08:30","09:00"],["13:30","14:00"]],
      'u-103' : [["09:15","09:45"],["16:00","16:30"]]
    };
    const tpl = fallbacks[userId] || [["10:00","10:30"]];
    return tpl.map(([s,e])=>({ start: dateAtTime(date,s), end: dateAtTime(date,e) }));
  }
  function proposedConflictsForUser(userId){
    const pr = getProposedRange(); if(!pr) return false;                 // no range -> no conflict
    if(!sameDay(pr.start, pr.end)) return true;                          // must stay same day
    const slots = getSlotsForUserOnDate(userId, pr.start);
    if(!slots.length) return true;                                       // no availability that day -> conflict
    const ok = slots.some(slot => pr.start>=slot.start && pr.end<=slot.end);
    return !ok;                                                          // only conflict if not contained in any slot
  }

  // ===== DOM =====
  const modal = document.getElementById('modal');
  document.getElementById('openModal').addEventListener('click',()=>{modal.classList.add('open')});
  document.getElementById('closeModal').addEventListener('click',()=>{modal.classList.remove('open')});
  modal.addEventListener('click',(e)=>{if(e.target===modal) modal.classList.remove('open')});

  const startDate = document.getElementById('startDate');
  const startTime = document.getElementById('startTime');
  const endDate   = document.getElementById('endDate');
  const endTime   = document.getElementById('endTime');

  // subtabs
  const tabInvitees = document.getElementById('tabInvitees');
  const tabStaff = document.getElementById('tabStaff');
  const panelInvitees = document.getElementById('panelInvitees');
  const panelStaff = document.getElementById('panelStaff');

  // invitees
  const customerPicker = document.getElementById('customerPicker');
  const suggestedContacts = document.getElementById('suggestedContacts');

  // staff
  const attendingStaff = document.getElementById('attendingStaff');

  // grouped always-visible block
  const groupStaff = document.getElementById('groupStaff');
  const groupInvitees = document.getElementById('groupInvitees');
  const availabilityMount = document.getElementById('availabilityMount');

  // steps + controls
  const dlgTitle = document.getElementById('dlgTitle');
  const step2Panel = document.getElementById('step2Panel');
  const step3Panel = document.getElementById('step3Panel');
  const step4Panel = document.getElementById('step4Panel');
  const step5Panel = document.getElementById('step5Panel');
  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  const scheduleBtn = document.getElementById('scheduleBtn');
  const step2Error = document.getElementById('step2Error');

  // step 4 agenda
  const agendaList = document.getElementById('agendaList');
  const addAgendaBtn = document.getElementById('addAgendaBtn');

  // step 5 location
  const locInPerson = document.getElementById('locInPerson');
  const locVirtual = document.getElementById('locVirtual');
  const inPersonPanel = document.getElementById('inPersonPanel');
  const virtualPanel = document.getElementById('virtualPanel');
  const recList = document.getElementById('recList');
  const orgSearch = document.getElementById('orgSearch');
  const searchResults = document.getElementById('searchResults');
  const addNewLink = document.getElementById('addNewLink');
  const zoomUrl = document.getElementById('zoomUrl');
  const selectedLocationEl = document.getElementById('selectedLocation');

  // Availability block (global mount)
  const staffAvailability = document.createElement('div');
  staffAvailability.className = 'avail reference';
  staffAvailability.id = 'staffAvailability';
  staffAvailability.setAttribute('role','note');
  staffAvailability.setAttribute('aria-label','Reference availability');
  staffAvailability.innerHTML = `
    <div class="avail-head">
      <div class="avail-title">
        <strong>Available times</strong>
        <span class="avail-muted" id="availabilityHint">Select a staff member to view availability.</span>
      </div>
      <div class="avail-muted" id="conflictNote"></div>
    </div>
    <div class="ref-banner" aria-hidden="true" title="This panel does not change your meeting times">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8"  x2="12" y2="8"></line>
      </svg>
      Please check a teammate’s calendar before you choose your own start/end above.
    </div>
    <div class="cal-wrap">
      <div class="cal">
        <div class="cal-head">
          <div class="cal-nav">
            <button class="chip" id="calPrev">◀</button>
            <button class="chip" id="calToday">Today</button>
            <button class="chip" id="calNext">▶</button>
          </div>
          <div class="cal-month" id="calMonthLabel">Month YYYY</div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div class="time-panel">
        <h4 id="timePanelTitle">Times</h4>
        <div class="time-list" id="timeList"></div>
      </div>
    </div>
  `;

  function init(){
    // mount availability globally
    availabilityMount.appendChild(staffAvailability);

    // Inline menus (Step 2)
    const statusBtn  = document.getElementById('statusValue');
    const statusMenu = document.getElementById('statusMenu');
    if (statusBtn && statusMenu) {
      statusBtn.textContent = state.status;
      mountInlineMenu(statusBtn, statusMenu, STATUS_OPTIONS, (val)=>{ state.status = val; syncStatusAcross(); });
    }

    const tzBtn  = document.getElementById('tzValue');
    const tzMenu = document.getElementById('tzMenu');
    tzBtn.textContent = state.timezone;
    mountInlineMenu(tzBtn, tzMenu, TZ_OPTIONS, (val)=>{ state.timezone = val; tzBtn.textContent = val; });

    // pickers
    // NOTE: remove organizer from the staff search box
    attendingStaff.innerHTML = `<option value="">-- Search Staff --</option>` +
      internalUsers.filter(u=>u.id!==organizer.id).map(u=>`<option value="${u.id}">${u.name} · ${u.title}</option>`).join('');
    customerPicker.innerHTML = `<option value="">— Select contact —</option>` + customers.map(c=>`<option value="${c.id}">${displayNameNameFirst(c.name)}</option>`).join('');

    renderSuggested();

    // default datetimes
    const now = new Date();
    now.setMinutes(now.getMinutes()<30?30:0,0,0);
    if(now.getMinutes()===0) now.setHours(now.getHours()+1);
    const later = new Date(now.getTime()+defaultSlotMinutes*60*1000);

    startDate.value = toISO(now).slice(0,10);
    startTime.value = toISO(now).slice(11,16);
    endDate.value   = toISO(later).slice(0,10);
    endTime.value   = toISO(later).slice(11,16);

    // start the calendar on the proposed date
    state.selectedCalDate = new Date(startDate.value + 'T00:00');

    tabStaff.addEventListener('click',   ()=> switchSub('staff'));
    tabInvitees.addEventListener('click',()=> switchSub('invitees'));

    // Invitees: auto-add on select
    customerPicker.addEventListener('change', ()=>{
      const id = customerPicker.value; 
      if(!id) return;
      const c = [...customers, ...suggested].find(x=>x.id===id);
      addInvitee(c);
      customerPicker.value='';
      renderGroupedParticipants();
    });

    // Suggested add (delegated)
    suggestedContacts.addEventListener('click', (e)=>{
      const id = e.target?.getAttribute?.('data-add-contact'); 
      if(!id) return;
      const c = suggested.find(x=>x.id===id);
      if(!c) return;
      addInvitee(c);
      suggested = suggested.filter(x=>x.id !== id);
      renderSuggested();
      renderGroupedParticipants();
    });

    attendingStaff.addEventListener('change', onStaffChange);

    document.getElementById('saveDraftBtn').addEventListener('click', ()=> alert('Saved draft. (mock)'));

    // Step navigation
    backBtn.addEventListener('click', goBack);
    nextBtn.addEventListener('click', goNext);
    scheduleBtn.addEventListener('click', ()=> alert('Scheduled! (mock)'));

    // Step 3/4/5 mirrors
    setupMirrors();

    // Step 4 agenda
    renderAgenda();
    addAgendaBtn.addEventListener('click', ()=>{
      const id = 'a' + Math.random().toString(36).slice(2,8);
      state.agendas.push({ id, title:'New Agenda Item', duration:5, desc:'Short description' });
      renderAgenda();
    });

    // Step 5 locations
    locInPerson.addEventListener('click', ()=> setLocationMode('inperson'));
    locVirtual.addEventListener('click', ()=> setLocationMode('virtual'));
    renderRecommended();
    renderSelectedLocation();

    orgSearch.addEventListener('input', ()=>{
      const q = orgSearch.value.trim().toLowerCase();
      if(!q){ searchResults.innerHTML = ''; return; }
      const matches = ORG_LOCATIONS.filter(addr=> addr.toLowerCase().includes(q));
      searchResults.innerHTML = matches.map(addr=>`
        <div class="rec-item">
          <div>${addr}</div>
          <button class="btn" data-choose-loc="${addr.replace(/"/g,'&quot;')}">Use</button>
        </div>
      `).join('') || `<div class="muted">No results.</div>`;
    });

    searchResults.addEventListener('click', (e)=>{
      const chosen = e.target?.getAttribute?.('data-choose-loc');
      if(!chosen) return;
      setSelectedLocation(chosen);
    });

    addNewLink.addEventListener('click', (e)=>{ e.preventDefault(); openAddLocation(); });

    document.getElementById('addLocClose').addEventListener('click', closeAddLocation);
    document.getElementById('addLocCancel').addEventListener('click', closeAddLocation);
    document.getElementById('addLocOverlay').addEventListener('click', (e)=>{ if(e.target===addLocOverlay) closeAddLocation(); });
    document.getElementById('saveLocationBtn').addEventListener('click', ()=>{
      const composed = composeAddress();
      if(!composed){ alert('Please enter at least an Address and City/State.'); return; }
      setSelectedLocation(composed);
      state.recommended.unshift(composed);
      renderRecommended();
      closeAddLocation();
      addr1.value = addr2.value = city.value = stateInput.value = zip.value = '';
    });

    // react to proposed time changes
    [startDate,startTime,endDate,endTime].forEach(el=> el.addEventListener('change', onProposedTimeChange));

    updateStepUI();

    document.getElementById('meetingName').addEventListener('input', e => { state.meetingName = e.target.value; syncNameAcross(); });

    // initial renders
    renderGroupedParticipants();
    renderAvailability(true); // initial render
  }

  function composeAddress(){
    const parts = [];
    if(addr1.value.trim()) parts.push(addr1.value.trim());
    if(addr2.value.trim()) parts.push(addr2.value.trim());
    const cityState = [city.value.trim(), stateInput.value.trim()].filter(Boolean).join(', ');
    if(cityState) parts.push(cityState);
    if(zip.value.trim()) parts.push(zip.value.trim());
    return parts.join(', ');
  }
  function openAddLocation(){ addLocOverlay.classList.add('open'); addLocOverlay.setAttribute('aria-hidden','false'); }
  function closeAddLocation(){ addLocOverlay.classList.remove('open'); addLocOverlay.setAttribute('aria-hidden','true'); }

  function renderSelectedLocation(){
    if(!state.selectedLocation || state.locationMode === 'virtual'){
      selectedLocationEl.textContent = '';
      selectedLocationEl.classList.add('hidden');
      return;
    }
    selectedLocationEl.textContent = state.selectedLocation;
    selectedLocationEl.classList.remove('hidden');
  }
  function setSelectedLocation(addr){ state.selectedLocation = addr; renderSelectedLocation(); }

  function syncNameAcross(){
    const s3 = document.getElementById('meetingName_s3');
    const s4 = document.getElementById('meetingName_s4');
    const s5 = document.getElementById('meetingName_s5');
    if(s3) s3.value = state.meetingName || '';
    if(s4) s4.value = state.meetingName || '';
    if(s5) s5.value = state.meetingName || '';
  }
  function syncStatusAcross(){
    ['statusValue','statusValue_s3','statusValue_s4','statusValue_s5']
      .forEach(id => { const el = document.getElementById(id); if (el) el.textContent = state.status; });
  }
  function syncStageAcross(){ /* fixed "Scheduling" */ }

  function setupMirrors(){
    [['statusValue_s3','statusMenu_s3'],['statusValue_s4','statusMenu_s4'],['statusValue_s5','statusMenu_s5']]
      .forEach(([btnId, menuId])=>{
        const btn = document.getElementById(btnId);
        const menu = document.getElementById(menuId);
        if (btn && menu) {
          mountInlineMenu(btn, menu, STATUS_OPTIONS, (v)=>{ state.status=v; syncStatusAcross(); });
        }
      });
    ['meetingName_s3','meetingName_s4','meetingName_s5'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', e => {
        state.meetingName = e.target.value;
        document.getElementById('meetingName').value = e.target.value;
        syncNameAcross();
      });
    });
  }

  function switchSub(which){
    const isStaff = which === 'staff';
    tabStaff.setAttribute('aria-selected', isStaff);
    tabInvitees.setAttribute('aria-selected', !isStaff);
    panelStaff.classList.toggle('active', isStaff);
    panelInvitees.classList.toggle('active', !isStaff);
    // grouped list + availability remain visible
  }

  // Staff picker -> auto-add, show availability, conflict alert
  function onStaffChange(){
    const id = attendingStaff.value || null;
    if (!id) return;

    state.staff = id;

    if (!state.staffOnMeeting.some(s => s.id === id)) {
      state.staffOnMeeting.push({ id });
      renderGroupedParticipants();
    }

    attendingStaff.value = '';

    renderAvailability();
    if (proposedConflictsForUser(id)) {
      alert(`Heads up: The proposed time conflicts with ${getUserById(id).name}'s calendar.`);
    }
  }

  function onProposedTimeChange(){
    if(startDate.value){
      state.selectedCalDate = new Date(startDate.value + 'T00:00');
    }
    renderAvailability();
    renderGroupedParticipants(); // updates conflict badges for organizer/staff
  }

  // Availability (calendar + list)
  function renderAvailability(initial=false){
    const grid = document.getElementById('calGrid');
    const monthLbl = document.getElementById('calMonthLabel');
    const timeList = document.getElementById('timeList');
    const timeTitle = document.getElementById('timePanelTitle');
    const availabilityHint = document.getElementById('availabilityHint');
    const conflictNote = document.getElementById('conflictNote');

    grid.innerHTML = '';
    timeList.innerHTML = '';

    let user = state.staff ? getUserById(state.staff) : null;
    if(!user){
      availabilityHint.textContent = 'Select a staff member to view availability.';
      renderCalSkeleton(grid);
      monthLbl.textContent = formatMonthLabel(state.refMonth);
      timeTitle.textContent = 'Times';
      timeList.innerHTML = `<div class="time-empty">No staff selected.</div>`;
      conflictNote.textContent = '';
      wireCalNav();
      return;
    }

    availabilityHint.textContent = `Showing ${user.name}'s availability`;
    const monthRef = isNovember(state.selectedCalDate) ? new Date(state.selectedCalDate) : new Date(state.refMonth);
    state.refMonth = monthRef;

    renderCalendar(grid, monthRef, state.selectedCalDate);
    monthLbl.textContent = formatMonthLabel(monthRef);
    wireCalNav();

    timeTitle.textContent = state.selectedCalDate.toLocaleDateString(undefined,{ weekday:'long', month:'long', day:'numeric' });

    const slots = getSlotsForUserOnDate(user.id, state.selectedCalDate);
    const isWeekend = [0,6].includes(state.selectedCalDate.getDay());

    const pr = getProposedRange();
    if (pr && sameDay(pr.start, state.selectedCalDate)) {
      const isConflict = proposedConflictsForUser(user.id);
      conflictNote.innerHTML = isConflict
        ? `<span class="conflict-badge">CONFLICT at ${fmtTime(pr.start)} – ${fmtTime(pr.end)}</span>`
        : `<span class="role-badge">Proposed: ${fmtTime(pr.start)} – ${fmtTime(pr.end)}</span>`;
    } else {
      conflictNote.textContent = '';
    }

    if(!slots.length){
      timeList.innerHTML = `<div class="time-empty">${isWeekend ? 'No availability on weekends.' : 'No available times for this date.'}</div>`;
    } else {
      const frag = document.createDocumentFragment();
      slots.forEach(s=>{
        const row = document.createElement('button');
        row.type = 'button';
        row.className = 'time-row';
        row.textContent = `${fmtTime(s.start)} – ${fmtTime(s.end)}`;
        const pr = getProposedRange();
        if (pr && sameDay(pr.start, s.start) && pr.start.getTime()===s.start.getTime() && pr.end.getTime()===s.end.getTime()){
          row.classList.add('active');
        }
        row.addEventListener('click', ()=>{
          startDate.value = toISO(s.start).slice(0,10);
          startTime.value = toISO(s.start).slice(11,16);
          endDate.value   = toISO(s.end).slice(0,10);
          endTime.value   = toISO(s.end).slice(11,16);
          onProposedTimeChange();
        });
        frag.appendChild(row);
      });
      timeList.appendChild(frag);
    }

    function wireCalNav(){
      document.getElementById('calPrev').onclick = ()=>{ shiftMonth(-1); };
      document.getElementById('calNext').onclick = ()=>{ shiftMonth(1); };
      document.getElementById('calToday').onclick = ()=>{
        const t = new Date();
        state.refMonth = new Date(t.getFullYear(), t.getMonth(), 1);
        state.selectedCalDate = startOfDay(t);
        renderAvailability();
      };
    }
    function shiftMonth(delta){
      const d = new Date(state.refMonth);
      d.setMonth(d.getMonth()+delta);
      state.refMonth = d;
      const first = startOfMonth(d), last = endOfMonth(d);
      if(state.selectedCalDate < first || state.selectedCalDate > last){
        state.selectedCalDate = new Date(d.getFullYear(), d.getMonth(), Math.min( new Date().getDate(), last.getDate() ));
      }
      renderAvailability();
    }
  }

  function renderCalendar(container, monthRef, selectedDate){
    renderCalSkeleton(container);
    const first = startOfMonth(monthRef);
    const last  = endOfMonth(monthRef);
    const gridStart = new Date(first); gridStart.setDate(first.getDate() - first.getDay());
    const gridEnd = new Date(last); gridEnd.setDate(last.getDate() + (6 - last.getDay()));
    const today = new Date();

    for(let d = new Date(gridStart); d <= gridEnd; d.setDate(d.getDate()+1)){
      const day = new Date(d);
      const btn = document.createElement('div');
      btn.className = 'cal-day';
      if(day.getMonth() !== monthRef.getMonth()) btn.classList.add('out');
      if(sameDay(day, today)) btn.classList.add('today');
      if(sameDay(day, selectedDate)) btn.classList.add('selected');
      btn.textContent = String(day.getDate());
      btn.addEventListener('click', ()=>{
        state.selectedCalDate = day;
        renderAvailability();
      });
      container.appendChild(btn);
    }
  }

  function renderCalSkeleton(container){
    container.innerHTML = '';
    for(let i=0;i<7;i++){
      const h = document.createElement('div');
      h.className = 'cal-dow';
      h.textContent = dayNameShort(i);
      container.appendChild(h);
    }
  }

  // AVATAR
  function avatarHTML(person){
    if(person.avatar){
      return `<span class="avatar"><img src="${person.avatar}" alt=""></span>`;
    }
    return `<span class="avatar" aria-hidden="true">${initialsFromName(person.name||'')}</span>`;
  }

  function getUserById(id){ return internalUsers.find(u=>u.id===id); }

  // Invitees & Staff management (rendered only in grouped section)
  function addInvitee(contact){
    if(!contact) return;
    if(state.invitees.some(i=>i.id===contact.id)) return;
    state.invitees.push({ id: contact.id, name: contact.name, displayName: displayNameNameFirst(contact.name), email: contact.email, phone: contact.phone || '', profileUrl: contact.profileUrl || '#', avatar: contact.avatar || '' });
  }
  function removeInvitee(id){
    state.invitees = state.invitees.filter(i=> i.id!==id);
    renderGroupedParticipants();
  }

  // Grouped (always visible) render: Staff then Invitees
  function renderGroupedParticipants(){
    groupStaff.innerHTML = '';
    groupInvitees.innerHTML = '';

    // Organizer first in Staff group
    const orgConflict = proposedConflictsForUser(organizer.id);
    groupStaff.appendChild(buildCard(organizer, {badge:'Organizer', showBadge:true, clickable:true, showConflict:orgConflict}));

    // Rest of staff (no bubbles)
    state.staffOnMeeting
      .filter(s => s.id !== organizer.id)
      .map(s => getUserById(s.id))
      .forEach(u => {
        const conflict = proposedConflictsForUser(u.id);
        groupStaff.appendChild(buildCard(u, {badge:'', showBadge:false, clickable:true, showConflict:conflict, removable:true, removeHandler:(id)=>{
          state.staffOnMeeting = state.staffOnMeeting.filter(x=>x.id!==id);
          renderGroupedParticipants(); renderAvailability();
        }}));
      });

    // Invitees (no bubbles)
    state.invitees.forEach(inv => {
      const person = { ...inv, name: inv.displayName || inv.name };
      groupInvitees.appendChild(buildCard(person, {badge:'', showBadge:false, clickable:false, removable:true, removeHandler:()=> removeInvitee(inv.id)}));
    });
  }

  function buildCard(person, opts){
    const {badge, showBadge, clickable, showConflict, removable, removeHandler} = Object.assign({badge:'', showBadge:false, clickable:false, showConflict:false, removable:false, removeHandler:null}, opts||{});
    const el = document.createElement('div');
    el.className = 'person-card';
    if(clickable){ el.dataset.clickable = 'true'; }

    // Build conflict label with explicit time if applicable
    let conflictHTML = '';
    if (showConflict) {
      const pr = getProposedRange();
      if (pr) {
        conflictHTML = `<span class="conflict-badge">CONFLICT at ${fmtTime(pr.start)} – ${fmtTime(pr.end)}</span>`;
      }
    }

    el.innerHTML = `
      <div class="person-left">
        ${avatarHTML(person)}
        <div class="meta">
          <div class="name-row">
            <strong>${person.name || person.displayName}</strong>
            ${showBadge ? `<span class="role-badge">${badge}</span>` : ``}
            ${conflictHTML}
            ${removable ? `<button class="remove-x" title="Remove" data-remove="1">×</button>` : ``}
          </div>
          ${person.title ? `<div class="subline">${person.title}</div>` : ``}
          ${person.email ? `<div class="subline">${person.email}</div>` : ``}
          ${person.phone ? `<div class="subline">${person.phone}</div>` : ``}
        </div>
      </div>
      <div class="person-right">
        ${person.profileUrl ? `<a class="view-link" href="${person.profileUrl}" target="_blank" rel="noopener">View Profile</a>` : ``}
      </div>
    `;
    if(clickable){
      el.addEventListener('click', ()=>{
        // clicking a staff in the rendered list should show their respective calendars
        if(person.id && getUserById(person.id)){ state.staff = person.id; renderAvailability(); }
      });
    }
    if(removable && removeHandler){
      el.querySelector('[data-remove]').addEventListener('click', (e)=>{
        e.stopPropagation();
        removeHandler(person.id);
      });
    }
    return el;
  }

  // Step Nav
  function goNext(){
    step2Error.style.display = 'none';

    if(state.step===2){
      if(state.staffOnMeeting.length === 0){
        step2Error.style.display = 'block';
        return;
      }
      state.meetingName = document.getElementById('meetingName').value;
      syncNameAcross();
      state.step = 3;
    } else if(state.step===3){
      state.descriptions.short = document.getElementById('shortDesc').value;
      state.descriptions.long  = document.getElementById('longDesc').innerHTML;
      state.descriptions.notes = document.getElementById('notesDesc').innerHTML;
      state.step = 4;
    } else if(state.step===4){
      state.step = 5;
    }
    updateStepUI();
  }
  function goBack(){
    step2Error.style.display = 'none';
    if(state.step>2){ state.step--; updateStepUI(); }
  }

  function updateStepUI(){
    step2Panel.classList.toggle('hidden', state.step!==2);
    step3Panel.classList.toggle('hidden', state.step!==3);
    step4Panel.classList.toggle('hidden', state.step!==4);
    step5Panel.classList.toggle('hidden', state.step!==5);

    dlgTitle.textContent =
      state.step===2 ? 'Step 2' :
      state.step===3 ? 'Step 3 – About This Meeting' :
      state.step===4 ? 'Step 4 – Agenda' :
      'Step 5 – Select Location';

    backBtn.classList.toggle('hidden', state.step===2);
    nextBtn.classList.toggle('hidden', state.step===5);
    scheduleBtn.classList.toggle('hidden', state.step!==5);
  }

  // Agenda
  function renderAgenda(){
    agendaList.innerHTML = '';
    state.agendas.forEach((a)=>{
      const item = document.createElement('div');
      item.className = 'agenda-item';
      item.setAttribute('draggable','true');
      item.dataset.id = a.id;

      item.innerHTML = `
        <div class="agenda-handle" aria-label="Drag to reorder">
          <div class="dots">${'<span></span>'.repeat(6)}</div>
        </div>
        <div class="agenda-main">
          <div class="view">
            <div class="agenda-title">${a.title}</div>
            <div class="agenda-sub">Duration: ${a.duration} Minutes</div>
            <div class="agenda-sub">${a.desc}</div>
          </div>
          <div class="edit">
            <div class="edit-row">
              <input class="input" data-edit-title value="${a.title}" placeholder="Agenda name" />
              <input class="input inline-num" type="number" min="0" data-edit-duration value="${a.duration}" />
            </div>
            <div class="edit-row">
              <input class="input" data-edit-desc value="${a.desc}" placeholder="Short description" />
            </div>
          </div>
        </div>
        <div class="agenda-actions">
          <button class="icon-btn" title="Edit" data-edit>
            <span class="icon">✏️</span>
          </button>
          <button class="icon-btn" title="Remove" data-remove>
            <span class="icon">✖</span>
          </button>
        </div>
      `;

      item.querySelector('[data-edit]').addEventListener('click', ()=>{
        const editing = item.classList.toggle('agenda-editing');
        if(!editing){
          const title = item.querySelector('[data-edit-title]').value.trim() || 'Untitled';
          const dur   = parseInt(item.querySelector('[data-edit-duration]').value||0,10);
          const desc  = item.querySelector('[data-edit-desc]').value.trim();
          a.title = title; a.duration = isNaN(dur)?0:dur; a.desc = desc;
          renderAgenda();
        }
      });

      item.querySelector('[data-remove]').addEventListener('click', ()=>{
        state.agendas = state.agendas.filter(x=>x.id!==a.id);
        renderAgenda();
      });

      item.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', a.id); item.style.opacity = .5; });
      item.addEventListener('dragend', ()=>{ item.style.opacity = 1; });
      item.addEventListener('dragover', (e)=>{ e.preventDefault(); item.style.borderColor = '#cfe0ff'; });
      item.addEventListener('dragleave', ()=>{ item.style.borderColor = 'var(--line)'; });
      item.addEventListener('drop', (e)=>{ e.preventDefault(); item.style.borderColor = 'var(--line)'; const draggedId = e.dataTransfer.getData('text/plain'); if(draggedId===a.id) return; const from = state.agendas.findIndex(x=>x.id===draggedId); const to = state.agendas.findIndex(x=>x.id===a.id); const [moved] = state.agendas.splice(from,1); state.agendas.splice(to,0,moved); renderAgenda(); });

      agendaList.appendChild(item);
    });
  }

  // Step 5 Location
  function setLocationMode(mode){
    state.locationMode = mode;
    const isInPerson = mode==='inperson';
    locInPerson.setAttribute('aria-selected', isInPerson);
    locVirtual.setAttribute('aria-selected', !isInPerson);
    inPersonPanel.classList.toggle('hidden', !isInPerson);
    virtualPanel.classList.toggle('hidden', isInPerson);
    renderSelectedLocation();
  }

  function renderRecommended(){
    recList.innerHTML = state.recommended.map(addr=>`
      <div class="rec-item">
        <div>${addr}</div>
        <button class="btn" data-choose-loc="${addr.replace(/"/g,'&quot;')}">Use</button>
      </div>
    `).join('');
  }
  recList.addEventListener('click', (e)=>{
    const chosen = e.target?.getAttribute?.('data-choose-loc');
    if(!chosen) return;
    setSelectedLocation(chosen);
  });
  zoomUrl.addEventListener('input', e=> state.zoomUrl = e.target.value );

  function initPanelsSync(){ syncNameAcross(); syncStatusAcross(); syncStageAcross(); }

  // Boot
  init();
  initPanelsSync();
</script>
</body>
</html>
